name: ğŸŸ£ Pella.app è‡ªåŠ¨ä¿æ´»ç»­æœŸ

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´ 09:30 å’Œ 23:30 (UTC 01:30, 15:30)
    - cron: '30 1 * * *'
    - cron: '30 15 * * *'
  workflow_dispatch:

jobs:
  pella_run:
    runs-on: ubuntu-latest
    
    # ğŸ‘‡ å¿…é¡»æ·»åŠ è¿™ä¸ªæƒé™ï¼Œå¦åˆ™æ— æ³•æäº¤ time.txt
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è®¾ç½® Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: ç¼“å­˜ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            ~/.cache/ms-playwright
          key: ${{ runner.os }}-pip-pella-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-pella-

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install -r requirements.txt
          python -m playwright install chromium

      - name: è¿è¡Œ Pella è„šæœ¬
        env:
          # å¿…é¡»åœ¨ Secrets ä¸­è®¾ç½®è¿™äº›å˜é‡
          PELLA_EMAIL: ${{ secrets.PELLA_EMAIL }}
          PELLA_PASSWORD: ${{ secrets.PELLA_PASSWORD }}
          PELLA_SERVER_ID: ${{ secrets.PELLA_SERVER_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          # å¼ºåˆ¶æ— å¤´æ¨¡å¼
          USE_HEADLESS: "true"
        run: python main.py

      # ğŸ‘‡ğŸ‘‡ğŸ‘‡ æ–°å¢: æäº¤ time.txt ä¿æ´»æ­¥éª¤ (å«é‡è¯•æœºåˆ¶) ğŸ‘‡ğŸ‘‡ğŸ‘‡
      - name: Commit time.txt (é˜²æ­¢60å¤©æš‚åœ)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # å†™å…¥å½“å‰æ—¶é—´
          echo "$(date +'%Y-%m-%d %H:%M:%S')" > time.txt

          git add time.txt

          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if git diff --cached --quiet; then
            echo "æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "â±ï¸ Pellaä¿æ´»: $(date +'%Y-%m-%d %H:%M:%S')"
            
            # é‡è¯•æœºåˆ¶ (é˜²æ­¢ GitHub æœåŠ¡å™¨æ³¢åŠ¨)
            MAX_RETRIES=3
            count=0
            success=false
            while [ $count -lt $MAX_RETRIES ]; do
              if git push origin HEAD:main; then
                echo "âœ… æ¨é€æˆåŠŸ"
                success=true
                break
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œ5ç§’åé‡è¯• ($((count+1))/$MAX_RETRIES)..."
                sleep 5
                git pull --rebase origin main
                count=$((count+1))
              fi
            done

            if [ "$success" = false ]; then
              echo "âŒ å¤šæ¬¡é‡è¯•åä»å¤±è´¥"
              exit 1
            fi
          fi
